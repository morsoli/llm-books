æœ¬ç”µå­ä¹¦å¼€æºï¼Œæ¬¢è¿ star ğŸŒŸï¼Œå…³æ³¨ã€ŠLLM åº”ç”¨å¼€å‘å®è·µç¬”è®°ã€‹

æˆ‘çš„æ–°ä¹¦[ã€ŠLangChainç¼–ç¨‹ä»å…¥é—¨åˆ°å®è·µã€‹](https://u.jd.com/V8pkqFY) å·²ç»å¼€å”®ï¼æ¨èæ­£åœ¨å­¦ä¹ AIåº”ç”¨å¼€å‘çš„æœ‹å‹è´­ä¹°é˜…è¯»ï¼
[![LangChainç¼–ç¨‹ä»å…¥é—¨åˆ°å®è·µ](../../images/langchain-book.jpg "LangChainç¼–ç¨‹ä»å…¥é—¨åˆ°å®è·µ")](https://u.jd.com/V8pkqFY) 

## å®ç°ä¸€ä¸ªå¥—å£³æœºå™¨äºº


### ç¯å¢ƒå‡†å¤‡
#### API ä»£ç†
å› ä¸º OpenAI åŸå§‹è¯·æ±‚åœ°å€`api.openai.com` ç›®å‰åœ¨å›½å†…å¤§éƒ¨åˆ†åœ°åŒºè®¿é—®å»¶è¿Ÿè¾ƒé«˜ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ª[å…è´¹è§£å†³åŠæ³•](https://github.com/noobnooc/noobnooc/discussions/9)ï¼ˆä½¿ç”¨ Cloudflare çš„ Workers æ¥ä»£ç† OpenAI çš„ API åœ°å€ï¼Œé…åˆè‡ªå·±çš„åŸŸåå®ç°ä½å»¶è¿Ÿè®¿é—®ï¼‰ï¼Œä¸ç”¨è‡ªå·±è´­ä¹°ä¸“é—¨ä»£ç†æœåŠ¡å™¨ã€‚

#### API çŠ¶æ€æ£€æŸ¥
OpenAIå®˜æ–¹æä¾›äº†ä¸€ä¸ª[API çŠ¶æ€é¡µé¢](https://status.openai.com/)ï¼Œå¯ä»¥çœ‹åˆ°æ¥å£å®æ—¶å»¶è¿Ÿï¼Œä»¥åŠå‡ºç°å¤§é¢ç§¯å®•æœºæ—¶ä¼šæ˜¾ç¤ºå…¬å‘Šã€‚

#### APIè´¹ç”¨è¯´æ˜
|              æ¨¡å‹åç§°              | context max tokens |      è¾“å…¥ä»·æ ¼       |      è¾“å‡ºä»·æ ¼      |
| :--------------------------------: | :----------------: | :-----------------: | :----------------: |
|           gpt-3.5-turbo            |        4096        | $0.0015 / 1K tokens | $0.002 / 1K tokens |
|         gpt-3.5-turbo-16k          |       16,384       | $0.003 / 1K tokens  | $0.004 / 1K tokens |
| gpt-3.5-turbo-0613ï¼ˆæ”¯æŒå‡½æ•°è°ƒç”¨ï¼‰ |        4096        | $0.0015 / 1K tokens | $0.002 / 1K tokens |
|       gpt-3.5-turbo-16k-0613       |       16,384       | $0.003 / 1K tokens  | $0.004 / 1K tokens |
|               gpt-4                |       8,192        |  $0.03 / 1K tokens  | $0.06 / 1K tokens  |
|             gpt-4-32k              |       32,768       |  $0.06 / 1K tokens  | $0.12 / 1K tokens  |
|     gpt-4-0613ï¼ˆæ”¯æŒå‡½æ•°è°ƒç”¨ï¼‰     |       8,192        |  $0.03 / 1K tokens  | $0.06 / 1K tokens  |
|           gpt-4-32k-0613           |       32,768       |  $0.06 / 1K tokens  | $0.12 / 1K tokens  |

#### Token è®¡æ•°
* å¯ä»¥ä½¿ç”¨[tiktoken](https://github.com/openai/tiktoken) è®¡ç®—åŸå§‹å­—ç¬¦ä¸²å¯¹åº”çš„ token æ•°ï¼›è¿™ç¯‡å…³äº[ChatGPTå¦‚ä½•è®¡ç®—tokenæ•°](https://www.zhihu.com/question/594159910/answer/2972923596)çš„ç§‘æ™®æ–‡ç« å€¼å¾—ä¸€è¯»
  ```python
  import tiktoken

  def num_tokens_from_string(string: str, encoding_name: str) -> int:
      """Returns the number of tokens in a text string."""
      encoding = tiktoken.get_encoding(encoding_name)
      num_tokens = len(encoding.encode(string))
      return num_tokens

  num_tokens_from_string("tiktoken is great!", "cl100k_base")
  ```

### ä»£ç å®ç°
è¿™é‡Œåˆ©ç”¨ Gradio å®ç° Web UI
#### [Gradioä»‹ç»](https://gradio.app/quickstart/)
Gradioæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºäº¤äº’å¼æœºå™¨å­¦ä¹ åº”ç”¨ç¨‹åºçš„Pythonåº“ï¼Œå¯ä»¥å¿«é€Ÿæ„å»ºå’Œéƒ¨ç½²äº¤äº’å¼UIï¼Œæ–¹ä¾¿ä¸æœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œäº¤äº’ã€‚Gradioæä¾›äº†ä¸€ç»„ç®€å•çš„APIï¼Œå¯ä»¥è½»æ¾åœ°å°†ä»£ç è½¬åŒ–ä¸ºä¸€ä¸ªWebåº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®©å…¶ä»–äººé€šè¿‡ç½‘é¡µç•Œé¢ä¸æ¨¡å‹è¿›è¡Œäº¤äº’ã€‚

Gradioæ”¯æŒåˆ›å»ºå„ç§ç±»å‹çš„äº¤äº’å¼UIï¼Œä¾‹å¦‚æ–‡æœ¬è¾“å…¥æ¡†ã€æ»‘å—ã€ä¸‹æ‹‰èœå•ç­‰ï¼Œä»¥åŠæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘å’Œè¡¨æ ¼æ•°æ®ã€‚Gradioè¿˜æä¾›äº†å†…ç½®çš„é¢„å¤„ç†å’Œåå¤„ç†åŠŸèƒ½ï¼Œä»¥ç¡®ä¿çš„è¾“å…¥å’Œè¾“å‡ºæ•°æ®æ ¼å¼æ­£ç¡®ã€‚

#### åŸºæœ¬çš„é—®ç­”å®ç°
ä½¿ç”¨APIå°†ç”¨æˆ·çš„è¾“å…¥å‘é€åˆ°OpenAIæ¨¡å‹ä¸­ï¼Œç„¶åå°†æ¨¡å‹ç”Ÿæˆçš„å“åº”è¿”å›ç»™ç”¨æˆ·ï¼Œä»è€Œå®ç°é—®ç­”ã€‚
```python
import gradio as gr
import os
import openai
openai.api_key = os.getenv("OPENAI_API_KEY")

def get_completion(input_text):
    completion = openai.ChatCompletion.create(
        model="gpt-3.5-turbo-0613",
        messages=[
            {"role": "user", "content": f"{input_text}"}
        ]
    )
    return completion.choices[0].message["content"]

def chatbot(input_text):
    response = get_completion(input_text)
    return response

iface = gr.Interface(fn=chatbot, inputs="text", outputs="text", title="Chatbot", encoding="utf-8")
iface.launch(share=True)
```

#### å¤šè½®å¯¹è¯å®ç°
åœ¨é—®ç­”çš„åŸºç¡€ä¸Šæ›´è¿›ä¸€æ­¥ï¼Œåœ¨æ¯ä¸ªè½®æ¬¡ä¸­ä¿ç•™ç”¨æˆ·ä¹‹å‰çš„è¾“å…¥å’Œæ¨¡å‹ç”Ÿæˆçš„å“åº”ï¼Œä»¥ä¾¿å°†å…¶ä¼ é€’ç»™ä¸‹ä¸€è½®å¯¹è¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥å®ç°æ›´åŠ è‡ªç„¶çš„å¯¹è¯æµç¨‹ï¼Œå¹¶æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚
```python
import os
import openai
import gradio
openai.api_key = os.getenv("OPENAI_API_KEY")

history_messages = []
def api_calling(input_text, history_conversation):
    if history_conversation:
        history_messages.extend([
			{"role": "user", "content": f"{history_conversation[-1][0]}"},
            {"role": "assistant", "content": f"{history_conversation[-1][1]}"}
		]
		)
    message = history_messages+[{"role": "user", "content": f"{input_text}"}]
    completion = openai.ChatCompletion.create(
        model="gpt-3.5-turbo-0613",          
        messages=message,
		max_tokens=1024,
		n=1,
		stop=None,
		temperature=0.5,
    )
    return completion.choices[0].message["content"]

def message_and_history(input, history):
    history = history or []
    output = api_calling(input, history)
    history.append((input, output))
    return history, history

block = gradio.Blocks(theme=gradio.themes.Monochrome())
with block:
    gradio.Markdown("""<h1><center>ğŸ¤–ï¸å¯¹è¯æœºå™¨äºº</center></h1>
    """)
    chatbot = gradio.Chatbot()
    message = gradio.Textbox(placeholder="è¾“å…¥ä½ çš„é—®é¢˜")
    state = gradio.State()
    submit = gradio.Button("å‘é€")
    submit.click(message_and_history,
          inputs=[message, state],
          outputs=[chatbot, state])
block.launch(share=True, debug=True)
```

#### æŒ‡å®šåŠŸèƒ½çš„æœºå™¨äºº
é€šè¿‡ é¢„è®¾[Prompt](../ref/prompt.md) çš„æ–¹å¼å®ç°ï¼Œå½“å‰çœ‹åˆ°çš„ 99% çš„å¤šåŠŸèƒ½é›†æˆå¹³å°éƒ½æ˜¯ç”¨è¿™ç§æ–¹å¼ã€‚

- å»ºè®®ä½¿ç”¨è‹±æ–‡è®¾ç½®`é¢„è®¾æç¤ºè¯`
- ä½¿ç”¨ç±»ä¼¼`If asked about others please say 'I am only Chinese translator'`çš„è¯­å¥è¿›è¡Œåˆçº§çš„æç¤ºæ³„æ¼é¢„é˜²

ä½¿ç”¨ä¹‹å‰![](../images/prompt1.png)
ä½¿ç”¨ä¹‹å![](../images/prompt2.png)

```python
import gradio as gr
import os
import openai
openai.api_key = os.getenv("OPENAI_API_KEY")

PROMPT_ROLE = """
I want you to act as an Chinese translator, spelling corrector and improver. \n
I will speak to you in any language and you will detect the language,\n 
translate it and answer in the corrected and improved version of my text, in Chinese.\n 
Keep the meaning same, but make them more literary. I want you to only reply the correction,\n
the improvements and nothing else, do not write explanations. If asked about others please say 'I am only Chinese translator'
"""
def get_completion(input_text):
    message = [{"role": "system", "content": PROMPT_ROLE}]
    message.append({"role": "user", "content": f"{input_text}"})
    completion = openai.ChatCompletion.create(
        model="gpt-3.5-turbo-0613",
        messages=message,
    )
    return completion.choices[0].message["content"]

def chatbot(input_text):
    response = get_completion(input_text)
    return response

iface = gr.Interface(fn=chatbot, inputs="text", outputs="text", title="ğŸ¤–ï¸ä¸­æ–‡ç¿»è¯‘", encoding="utf-8")
iface.launch(share=True, debug=True)
```

